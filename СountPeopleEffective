#include <Wire.h>
#include <VL53L0X.h>

VL53L0X lox;  // Объект датчика расстояния MGS-20

const int ledPin = 13;      // Пин светодиода
int peopleCount = 0;        // Счётчик людей
uint16_t lastDist = 2000;   // Последнее расстояние (мм), изначально далеко
unsigned long lastCount = 0; // Время последнего срабатывания

void setup() {
  Serial.begin(115200);     // Быстрая отладка
  Wire.begin();             // I2C шина
  pinMode(ledPin, OUTPUT);  // LED выход
  
  // Инициализация датчика
  lox.init();
  lox.setTimeout(500);      // Таймаут 500мс при ошибке
  lox.setMeasurementTimingBudget(20000); // Быстрые измерения ~20мс
  lox.startContinuous();    // Непрерывный режим
  
  Serial.println("Счётчик людей MGS-20 готов (порог 50см)");
}

void loop() {
  // Читаем расстояние (неблокирующе)
  uint16_t val7 = lox.readRangeContinuousMillimeters();
  if (lox.timeoutOccurred()) {
    val7 = 2000;  // Нет объекта = далеко
  }
  
  // Детекция входа: было далеко (>50см) → стало близко (≤50см) + debounce 2с
  if (lastDist > 500 && val7 <= 500 && millis() - lastCount > 2000) {
    peopleCount++;                    // Считаем человека
    lastCount = millis();             // Обновляем debounce
    digitalWrite(ledPin, HIGH);       // Зажигаем LED
    Serial.println("Вошёл! Всего: " + String(peopleCount));
  }
  
  // Авто-гашение LED через 500мс
  if (digitalRead(ledPin) && millis() - lastCount > 500) {
    digitalWrite(ledPin, LOW);
  }
  
  lastDist = val7;  // Сохраняем для следующей итерации
}
