import socket
import threading
import json
import sys
import time
from flask import Flask, render_template, jsonify, request
from collections import deque
from datetime import datetime

# ====== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ======
SERVER_IP = "10.164.135.55"  # IP —Å–µ—Ä–≤–µ—Ä–∞ –π–æ—Ç–∏–∫–∞
SERVER_PORT = 8889
FLASK_HOST = "0.0.0.0"
FLASK_PORT = 5000


# ====== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ======
class ControlPanel:
    def __init__(self):
        self.sock = None
        self.connected = False
        self.messages = deque(maxlen=50)  # –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π
        self.yotik_status = {"connected": False, "ip": None, "last_seen": None}
        self.lock = threading.Lock()

    def add_message(self, msg_type, content):
        with self.lock:
            self.messages.append({
                "timestamp": datetime.now().strftime("%H:%M:%S"),
                "type": msg_type,
                "content": content
            })

    def get_messages(self):
        with self.lock:
            return list(self.messages)

    def update_yotik_status(self, connected, ip=None):
        with self.lock:
            self.yotik_status["connected"] = connected
            self.yotik_status["ip"] = ip
            self.yotik_status["last_seen"] = datetime.now().strftime("%H:%M:%S")


# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
panel = ControlPanel()


# ====== –°–û–ö–ï–¢-–ö–õ–ò–ï–ù–¢ ======
def listen_server(sock):
    """–ü–æ—Ç–æ–∫ –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –π–æ—Ç–∏–∫–∞"""
    while panel.connected:
        try:
            data = sock.recv(4096)
            if not data:
                panel.add_message("system", "–°–µ—Ä–≤–µ—Ä –∑–∞–∫—Ä—ã–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ")
                panel.update_yotik_status(False)
                break

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ–¥–Ω–æ–º –ø–∞–∫–µ—Ç–µ
            for raw_msg in data.decode('utf-8').split('\n'):
                if not raw_msg.strip():
                    continue
                try:
                    msg = json.loads(raw_msg)
                    data = json.dumps(msg, ensure_ascii=False)
                    if "yotik" in data:
                        panel.add_message("success", ", ".join([f"–õ—é–¥–µ–π –≤–æ—à–ª–æ {data['yotik']['PeopleCounter']}", f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {data['arduino']['temperature']}", f"–ó–∞–ø–∞—Å—ã {data['arduino']['potentiometer']}", f"–†–∞–¥–∏–∞—Ü–∏—è {data["arduino"]["geiger_count"]}", f"–í–ª–∞–∂–Ω–æ—Å—Ç—å {data["arduino"]["humidity"]}", f"–ì–µ—Ä–º–æ–∑–∞—Ç–≤–æ—Ä {'–æ—Ç–∫—Ä—ã—Ç' if data['yotik']['DoorPosition'] else '–∑–∞–∫—Ä—ã—Ç'}"]))

                    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
                    if msg.get("event") == "yotik_disconnected":
                        panel.add_message("warning", "‚ö†Ô∏è –ô–û–¢–ò–ö –æ—Ç–∫–ª—é—á—ë–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞!")
                        panel.update_yotik_status(False)
                    elif msg.get("event") == "yotik_connected":
                        ip = msg.get('ip', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                        panel.add_message("success", f"‚úÖ –ô–û–¢–ò–ö –ø–æ–¥–∫–ª—é—á—ë–Ω! IP: {ip}")
                        panel.update_yotik_status(True, ip)
                except json.JSONDecodeError:
                    panel.add_message("text", raw_msg)
        except ConnectionResetError:
            panel.add_message("error", "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ")
            panel.update_yotik_status(False)
            break
        except Exception as e:
            if "–í–æ—Ç" not in str(e):
                panel.add_message("error", f"–û—à–∏–±–∫–∞ –ø—Ä–∏—ë–º–∞: {e}")
            break

    panel.connected = False
    panel.sock = None


def connect_to_server():
    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –π–æ—Ç–∏–∫–∞"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((SERVER_IP, SERVER_PORT))
        panel.sock = sock
        panel.connected = True
        panel.add_message("system", f"‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É {SERVER_IP}:{SERVER_PORT}")
        panel.update_yotik_status(True)

        # –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
        threading.Thread(target=listen_server, args=(sock,), daemon=True).start()
        return True
    except ConnectionRefusedError:
        panel.add_message("error", f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ {SERVER_IP}:{SERVER_PORT}")
        panel.add_message("error", "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ: 1) –ó–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä 2) –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ IP 3) –ë—Ä–∞–Ω–¥–º–∞—É—ç—Ä")
        return False
    except Exception as e:
        panel.add_message("error", f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return False


def send_command_to_yotik(cmd):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä –π–æ—Ç–∏–∫–∞"""
    if not panel.connected or panel.sock is None:
        return {"status": "error", "message": "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É –π–æ—Ç–∏–∫–∞"}

    try:
        panel.sock.sendall(cmd.encode('utf-8'))
        panel.add_message("command", f"üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: {cmd}")
        return {"status": "success", "message": f"–ö–æ–º–∞–Ω–¥–∞ '{cmd}' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞"}
    except Exception as e:
        panel.add_message("error", f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
        panel.connected = False
        return {"status": "error", "message": f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}"}


# ====== FLASK –í–ï–ë-–°–ï–†–í–ï–† ======
app = Flask(__name__)


@app.route('/')
def index():
    return render_template('index.html')


@app.route('/api/status')
def get_status():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã"""
    return jsonify({
        "connected": panel.connected,
        "yotik_status": panel.yotik_status,
        "messages": panel.get_messages()
    })


@app.route('/api/send_command/<cmd>', methods=['POST'])
def send_command(cmd):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"""
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã
    valid_commands = {"1", "2", "3", "4", "5"}
    if cmd not in valid_commands:
        return jsonify({"status": "error", "message": f"–ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –î–æ—Å—Ç—É–ø–Ω—ã: {', '.join(valid_commands)}"}), 400

    return jsonify(send_command_to_yotik(cmd))


@app.route('/api/connect', methods=['POST'])
def reconnect():
    """–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É"""
    if panel.connected:
        return jsonify({"status": "info", "message": "–£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É"})

    success = connect_to_server()
    return jsonify({
        "status": "success" if success else "error",
        "message": "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ" if success else "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"
    })


# ====== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ======
def main():
    print("=" * 60)
    print("–ô–û–¢–ò–ö –ü–£–õ–¨–¢ –£–ü–†–ê–í–õ–ï–ù–ò–Ø - –í–ï–ë –ò–ù–¢–ï–†–§–ï–ô–°")
    print("=" * 60)
    print(f"IP —Å–µ—Ä–≤–µ—Ä–∞ –π–æ—Ç–∏–∫–∞: {SERVER_IP}:{SERVER_PORT}")
    print(f"–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: http://localhost:{FLASK_PORT}")
    print("=" * 60)

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –π–æ—Ç–∏–∫–∞
    print("\n–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –π–æ—Ç–∏–∫–∞...")
    connect_to_server()

    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    print(f"\n–ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ http://localhost:{FLASK_PORT}")
    print("   –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n")

    flask_thread = threading.Thread(
        target=lambda: app.run(host=FLASK_HOST, port=FLASK_PORT, debug=False, use_reloader=False),
        daemon=True
    )
    flask_thread.start()

    # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –¥–ª—è –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–Ω—Å–æ–ª–∏: 1, 2, 5, 0, exit")
    print("–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –±—Ä–∞—É–∑–µ—Ä–µ!\n")

    try:
        while True:
            cmd = input("–ö–û–ù–°–û–õ–¨ >>> ").strip().lower()
            if cmd == "exit":
                print("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...")
                break
            if cmd in ("1", "2", "5", "0"):
                send_command_to_yotik(cmd)
            else:
                print("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –î–æ—Å—Ç—É–ø–Ω–æ: 1, 2, 5, 0, exit")
    except KeyboardInterrupt:
        print("\n\nüëã –í—ã—Ö–æ–¥ –ø–æ Ctrl+C")
    finally:
        if panel.sock:
            panel.sock.close()
        print("–ü—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")


if __name__ == "__main__":
    main()