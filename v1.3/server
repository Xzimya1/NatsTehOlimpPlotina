import socket
import threading
import json
import time
import sqlite3
import csv
from datetime import datetime
import os

# –ü–æ—Ä—Ç—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
YOTIK_PORT = 8888  # –ô–û–¢–ò–ö (–±—É–Ω–∫–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
ARDUINO_PORT = 8887  # Arduino Mega (–¥–∞—Ç—á–∏–∫–∏)
PULT_PORT = 8889  # –ü—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∏ –¥–∞–Ω–Ω—ã—Ö
yotik_conn = None
arduino_conn = None
pult_conn = None
last_yotik_data = None  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ô–û–¢–ò–ö (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏!)
last_arduino_data = None  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Arduino (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏!)
lock = threading.Lock()

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –ª–æ–≥–æ–≤
DB_PATH = "bunker_data.db"
CSV_LOG = "bunker_log.csv"


def init_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SQLite –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–≤—Å—ë –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∞–Ω–∞–ª–∏–∑–∞)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS combined_readings (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            timestamp_server REAL NOT NULL,          -- –í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            timestamp_device INTEGER,                -- –í—Ä–µ–º—è —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–º—Å)
            bunker_number INTEGER,
            radiation_in TEXT,
            radiation_out TEXT,
            bunker_temperature TEXT,                 -- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ—Ç –ô–û–¢–ò–ö
            pof_status TEXT,
            people_count INTEGER,
            stocks_count INTEGER,
            door_position INTEGER,
            potentiometer FLOAT,
            arduino_temperature TEXT,                -- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ—Ç Arduino
            humidity TEXT,
            geiger_count INTEGER,
            motor_status TEXT,
            source_device TEXT NOT NULL,             -- "yotik" –∏–ª–∏ "arduino"
            raw_data TEXT NOT NULL,
            received_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # –¢–∞–±–ª–∏—Ü–∞ –∫–æ–º–∞–Ω–¥ –¥–ª—è –∞—É–¥–∏—Ç–∞
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS command_log (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            command TEXT NOT NULL,
            source TEXT NOT NULL,
            target_device TEXT NOT NULL,
            status TEXT NOT NULL,
            response TEXT,
            timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    conn.commit()
    conn.close()
    print(f"[‚úì] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞: {DB_PATH}")


def init_csv_log():
    """–°–æ–∑–¥–∞–Ω–∏–µ CSV —Ñ–∞–π–ª–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏"""
    if not os.path.exists(CSV_LOG):
        with open(CSV_LOG, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            writer.writerow([
                'received_at', 'timestamp_server', 'timestamp_device', 'source',
                'bunker_number', 'radiation_in', 'radiation_out', 'bunker_temperature',
                'pof_status', 'people_count', 'stocks_count', 'door_position',
                'potentiometer', 'arduino_temperature', 'humidity', 'geiger_count',
                'motor_status', 'raw_data'
            ])
        print(f"[‚úì] CSV –ª–æ–≥ —Å–æ–∑–¥–∞–Ω: {CSV_LOG}")


def save_combined_data(source: str, data_dict: dict, raw_json: str):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –µ–¥–∏–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –º–∞–ø–ø–∏–Ω–≥–æ–º –ø–æ–ª–µ–π"""
    try:
        timestamp_server = time.time()
        timestamp_device = data_dict.get('timestamp', int(timestamp_server * 1000))

        # –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π (—Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –∏ –Ω–∞–∑–≤–∞–Ω–∏—è!)
        bunker_number = data_dict.get('BunkerNumber', data_dict.get('bunker_number', None))
        radiation_in = data_dict.get('RadiationLevelIn', data_dict.get('radiation_in', None))
        radiation_out = data_dict.get('RadiationLevelOut', data_dict.get('radiation_out', None))
        bunker_temp = data_dict.get('temperature', None)  # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ—Ç –ô–û–¢–ò–ö
        pof_status = data_dict.get('POF', data_dict.get('pof_status', None))
        people_count = data_dict.get('PeopleCounter', data_dict.get('people_count', None))
        stocks_count = data_dict.get('NumberOfStocks', data_dict.get('stocks_count', None))
        door_position = data_dict.get('DoorPosition', data_dict.get('door_position', None))

        # –ü–æ–ª—è –æ—Ç Arduino (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è!)
        potentiometer = data_dict.get('potentiometer', None)
        arduino_temp = data_dict.get('temperature',
                                     None)  # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ—Ç Arduino (–º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –ô–û–¢–ò–ö - –ø–æ—ç—Ç–æ–º—É —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è)
        humidity = data_dict.get('humidity', None)
        geiger_count = data_dict.get('geiger_count', data_dict.get('GeigerCount', None))
        motor_status = data_dict.get('motor_status', data_dict.get('MotorStatus', None))

        received_at = datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ SQLite
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO combined_readings 
            (timestamp_server, timestamp_device, bunker_number, radiation_in, radiation_out,
             bunker_temperature, pof_status, people_count, stocks_count, door_position,
             potentiometer, arduino_temperature, humidity, geiger_count, motor_status,
             source_device, raw_data)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            timestamp_server, timestamp_device, bunker_number, radiation_in, radiation_out,
            bunker_temp, pof_status, people_count, stocks_count, door_position,
            potentiometer, arduino_temp, humidity, geiger_count, motor_status,
            source, raw_json
        ))
        conn.commit()
        conn.close()

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CSV
        with open(CSV_LOG, 'a', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            writer.writerow([
                received_at, timestamp_server, timestamp_device, source,
                bunker_number, radiation_in, radiation_out, bunker_temp,
                pof_status, people_count, stocks_count, door_position,
                potentiometer, arduino_temp, humidity, geiger_count,
                motor_status, raw_json[:250]  # –û–±—Ä–µ–∑–∞–µ–º –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ CSV
            ])

        print(f"[üíæ] {source.upper()} –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: {len(raw_json)} –±–∞–π—Ç")
        return True

    except Exception as e:
        print(f"[!] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è {source} –¥–∞–Ω–Ω—ã—Ö: {e}")
        return False


def log_command(command: str, source: str, target_device: str, status: str, response: str = ""):
    """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –¥–ª—è –∞—É–¥–∏—Ç–∞"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO command_log (command, source, target_device, status, response)
            VALUES (?, ?, ?, ?, ?)
        ''', (command, source, target_device, status, response))
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"[!] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: {e}")


def send_to_pult(message: dict):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ JSON-—Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –ø—É–ª—å—Ç"""
    global pult_conn
    if not pult_conn:
        return

    try:
        json_msg = json.dumps(message, ensure_ascii=False) + "\n"
        pult_conn.sendall(json_msg.encode('utf-8'))
        # –ö—Ä–∞—Ç–∫–∏–π –ª–æ–≥ –≤ –∫–æ–Ω—Å–æ–ª—å (–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ JSON)
        if message.get("type") == "full_state":
            print(f"[‚Üí –ü–£–õ–¨–¢] –ü–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ({len(json_msg)} –±–∞–π—Ç)")
        else:
            print(f"[‚Üí –ü–£–õ–¨–¢] {message.get('type', 'unknown')}")
    except Exception as e:
        print(f"[!] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –ø—É–ª—å—Ç: {e}")
        with lock:
            try:
                pult_conn.close()
            except:
                pass
            pult_conn = None


def parse_device_message(raw_msg: str):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ–ª–µ–π"""
    raw_msg = raw_msg.strip()

    # –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ —á–∏—Å—Ç—ã–π JSON (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏!)
    if raw_msg.startswith('{') and raw_msg.endswith('}'):
        try:
            data = json.loads(raw_msg)
            return "json", data
        except json.JSONDecodeError:
            pass

    # –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ key=value (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏!)
    if "=" in raw_msg:
        try:
            parts = {}
            for item in raw_msg.split("&"):
                if "=" in item:
                    k, v = item.split("=", 1)
                    parts[k.strip()] = v.strip()
            return "kv", parts
        except Exception:
            pass

    return "raw", raw_msg


def get_full_state():
    """–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–û–õ–ù–û–ì–û –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ JSON —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
    with lock:
        state = {
            "type": "full_state",
            "timestamp": time.time(),
            "status": {
                "yotik_connected": yotik_conn is not None,
                "arduino_connected": arduino_conn is not None,
                "server_uptime": time.time() - server_start_time
            }
        }

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ô–û–¢–ò–ö —Å –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ú–ò –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ–ª–µ–π!
        if last_yotik_data is not None:
            state["yotik"] = last_yotik_data.copy()  # –ö–æ–ø–∏—Ä—É–µ–º —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–∫–∏

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç Arduino —Å –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ú–ò –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ–ª–µ–π!
        if last_arduino_data is not None:
            state["arduino"] = last_arduino_data.copy()

        return state


def handle_yotik(conn, addr):
    global yotik_conn, last_yotik_data
    with lock:
        yotik_conn = conn
    print(f"\n[‚úì] –ô–û–¢–ò–ö –ø–æ–¥–∫–ª—é—á—ë–Ω: {addr[0]}:{addr[1]}")
    send_to_pult({"event": "yotik_connected", "ip": addr[0]})

    try:
        while True:
            data = conn.recv(4096)
            if not data:
                break

            raw_msg = data.decode('utf-8', errors='ignore').strip()
            if not raw_msg:
                continue

            print(f"[‚Üê –ô–û–¢–ò–ö] {raw_msg[:80]}...")

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
            if raw_msg in ("1", "2", "3", "4", "5"):
                send_to_pult({
                    "type": "command_confirmation",
                    "command": raw_msg,
                    "device": "yotik",
                    "timestamp": time.time()
                })
                log_command(raw_msg, "yotik", "yotik", "confirmed", raw_msg)
                continue

            # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ–ª–µ–π
            msg_type, parsed_data = parse_device_message(raw_msg)

            if msg_type in ("json", "kv"):
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
                with lock:
                    last_yotik_data = parsed_data.copy()

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                save_combined_data("yotik", parsed_data, raw_msg)

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ü–û–õ–ù–´–ô –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π JSON –Ω–∞ –ø—É–ª—å—Ç
                full_state = get_full_state()
                send_to_pult(full_state)

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ô–û–¢–ò–ö
                try:
                    conn.sendall(b"cmd=ok&status=received\n")
                except:
                    break
            else:
                print(f"[!] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç –ô–û–¢–ò–ö: {raw_msg[:50]}")

    except Exception as e:
        print(f"[!] –û—à–∏–±–∫–∞ –ô–û–¢–ò–ö: {e}")
    finally:
        with lock:
            yotik_conn = None
        conn.close()
        print(f"\n[‚úó] –ô–û–¢–ò–ö –æ—Ç–∫–ª—é—á—ë–Ω: {addr[0]}")
        send_to_pult({"event": "yotik_disconnected", "ip": addr[0]})


def handle_arduino(conn, addr):
    global arduino_conn, last_arduino_data
    with lock:
        arduino_conn = conn
    print(f"\n[‚úì] Arduino –ø–æ–¥–∫–ª—é—á—ë–Ω: {addr[0]}:{addr[1]}")
    send_to_pult({"event": "arduino_connected", "ip": addr[0]})

    try:
        while True:
            data = conn.recv(4096)
            if not data:
                break

            raw_msg = data.decode('utf-8', errors='ignore').strip()
            if not raw_msg:
                continue

            print(f"[‚Üê ARDUINO] {raw_msg[:80]}...")

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
            if raw_msg in ("1", "2", "3", "4", "5"):
                send_to_pult({
                    "type": "command_confirmation",
                    "command": raw_msg,
                    "device": "arduino",
                    "timestamp": time.time()
                })
                log_command(raw_msg, "arduino", "arduino", "confirmed", raw_msg)
                continue

            # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ–ª–µ–π
            msg_type, parsed_data = parse_device_message(raw_msg)

            if msg_type in ("json", "kv"):
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
                with lock:
                    last_arduino_data = parsed_data.copy()

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                save_combined_data("arduino", parsed_data, raw_msg)

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ü–û–õ–ù–´–ô –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π JSON –Ω–∞ –ø—É–ª—å—Ç
                full_state = get_full_state()
                send_to_pult(full_state)

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç Arduino
                try:
                    conn.sendall(b"cmd=ok&status=received\n")
                except:
                    break
            else:
                print(f"[!] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç Arduino: {raw_msg[:50]}")

    except Exception as e:
        print(f"[!] –û—à–∏–±–∫–∞ Arduino: {e}")
    finally:
        with lock:
            arduino_conn = None
        conn.close()
        print(f"\n[‚úó] Arduino –æ—Ç–∫–ª—é—á—ë–Ω: {addr[0]}")
        send_to_pult({"event": "arduino_disconnected", "ip": addr[0]})


def handle_pult(conn, addr):
    global pult_conn
    with lock:
        pult_conn = conn
    print(f"\n[‚úì] –ü–£–õ–¨–¢ –ø–æ–¥–∫–ª—é—á—ë–Ω: {addr[0]}:{addr[1]}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    full_state = get_full_state()
    send_to_pult(full_state)

    try:
        while True:
            data = conn.recv(1024)
            if not data:
                break

            cmd = data.decode('utf-8').strip()
            print(f"[‚Üê –ü–£–õ–¨–¢] –ö–æ–º–∞–Ω–¥–∞: '{cmd}'")

            # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ô–û–¢–ò–ö (1-5)
            if cmd in ("1", "2", "3", "4", "5"):
                if yotik_conn:
                    try:
                        yotik_conn.sendall((cmd + "\n").encode('utf-8'))
                        print(f"[‚Üí –ô–û–¢–ò–ö] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: {cmd}")
                        send_to_pult({
                            "type": "command_sent",
                            "command": cmd,
                            "device": "yotik",
                            "status": "delivered"
                        })
                        log_command(cmd, "pult", "yotik", "delivered")
                    except Exception as e:
                        send_to_pult({
                            "type": "command_error",
                            "command": cmd,
                            "device": "yotik",
                            "error": f"–ô–û–¢–ò–ö –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {str(e)}"
                        })
                        log_command(cmd, "pult", "yotik", "failed", str(e))
                else:
                    send_to_pult({
                        "type": "command_error",
                        "command": cmd,
                        "device": "yotik",
                        "error": "–ô–û–¢–ò–ö –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω"
                    })
                    log_command(cmd, "pult", "yotik", "failed", "disconnected")

            # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è Arduino (a1-a5)
            elif cmd in ("a1"):
                arduino_cmd = cmd[1:]  # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å 'a'
                if arduino_conn:
                    try:
                        arduino_conn.sendall((arduino_cmd + "\n").encode('utf-8'))
                        print(f"[‚Üí ARDUINO] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: {arduino_cmd}")
                        send_to_pult({
                            "type": "command_sent",
                            "command": arduino_cmd,
                            "device": "arduino",
                            "status": "delivered"
                        })
                        log_command(arduino_cmd, "pult", "arduino", "delivered")
                    except Exception as e:
                        send_to_pult({
                            "type": "command_error",
                            "command": arduino_cmd,
                            "device": "arduino",
                            "error": f"Arduino –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {str(e)}"
                        })
                        log_command(arduino_cmd, "pult", "arduino", "failed", str(e))
                else:
                    send_to_pult({
                        "type": "command_error",
                        "command": arduino_cmd,
                        "device": "arduino",
                        "error": "Arduino –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω"
                    })
                    log_command(arduino_cmd, "pult", "arduino", "failed", "disconnected")

            else:
                send_to_pult({
                    "type": "invalid_command",
                    "received": cmd,
                    "valid_commands": ["1-5 (–ô–û–¢–ò–ö)", "a1-a5 (Arduino)"]
                })
    except Exception as e:
        print(f"[!] –û—à–∏–±–∫–∞ –ø—É–ª—å—Ç–∞: {e}")
    finally:
        with lock:
            pult_conn = None
        conn.close()
        print(f"\n[‚úó] –ü–£–õ–¨–¢ –æ—Ç–∫–ª—é—á—ë–Ω: {addr[0]}")


def start_server(port, handler, name):
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        s.bind(('0.0.0.0', port))
        s.listen(5)
        print(f"[–°–ï–†–í–ï–†] {name} —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç {port}")
        while True:
            conn, addr = s.accept()
            threading.Thread(target=handler, args=(conn, addr), daemon=True).start()


def show_stats():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute(
            "SELECT COUNT(*), COUNT(CASE WHEN source_device='yotik' THEN 1 END), COUNT(CASE WHEN source_device='arduino' THEN 1 END) FROM combined_readings")
        total, yotik_count, arduino_count = cursor.fetchone()

        cursor.execute("SELECT COUNT(*), COUNT(CASE WHEN status='delivered' THEN 1 END) FROM command_log")
        cmd_total, cmd_ok = cursor.fetchone()

        conn.close()

        print("\n" + "=" * 60)
        print("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ï–†–í–ï–†–ê")
        print("=" * 60)
        print(f"üíæ –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {total}")
        print(f"   ‚îú‚îÄ –ô–û–¢–ò–ö: {yotik_count}")
        print(f"   ‚îî‚îÄ Arduino: {arduino_count}")
        print(f"üïπÔ∏è  –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–æ–º–∞–Ω–¥: {cmd_total} (—É—Å–ø–µ—à–Ω–æ: {cmd_ok})")
        print(f"üìÅ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {os.path.abspath(DB_PATH)}")
        print(f"üìÑ CSV –ª–æ–≥: {os.path.abspath(CSV_LOG)}")
        print("=" * 60 + "\n")

    except Exception as e:
        print(f"[!] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")


# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
server_start_time = time.time()

if __name__ == "__main__":
    print("=" * 60)
    print("üöÄ –°–ï–†–í–ï–† –£–ü–†–ê–í–õ–ï–ù–ò–Ø: –ï–î–ò–ù–´–ô JSON –î–õ–Ø –ü–£–õ–¨–¢–ê")
    print("=" * 60)
    print("–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞:")
    print("1. –≠—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä (—É–∂–µ –∑–∞–ø—É—â–µ–Ω)")
    print("2. –ô–û–¢–ò–ö ‚Üí –ø–æ—Ä—Ç 8888 (–±—É–Ω–∫–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)")
    print("3. Arduino Mega ‚Üí –ø–æ—Ä—Ç 8890 (–¥–∞—Ç—á–∏–∫–∏)")
    print("4. –ü–£–õ–¨–¢ ‚Üí –ø–æ—Ä—Ç 8889")
    print("=" * 60)
    print("\nüí° –í–ê–ñ–ù–û: –ü—É–ª—å—Ç –ø–æ–ª—É—á–∞–µ—Ç –ï–î–ò–ù–´–ô JSON —Å–æ –í–°–ï–ú–ò –¥–∞–Ω–Ω—ã–º–∏!")
    print("   –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:")
    print("   {")
    print('     "type": "full_state",')
    print('     "timestamp": 123456789.123,')
    print('     "status": { ... },')
    print('     "yotik": { "BunkerNumber":1, "RadiationLevelIn":"...", ... },')
    print('     "arduino": { "potentiometer":512, "geiger_count":123, ... }')
    print("   }")
    print("=" * 60)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    init_database()
    init_csv_log()
    show_stats()

    # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤
    threading.Thread(target=start_server, args=(YOTIK_PORT, handle_yotik, "–ô–û–¢–ò–ö"), daemon=True).start()
    threading.Thread(target=start_server, args=(ARDUINO_PORT, handle_arduino, "ARDUINO"), daemon=True).start()
    threading.Thread(target=start_server, args=(PULT_PORT, handle_pult, "–ü–£–õ–¨–¢"), daemon=True).start()

    # –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
    print("  stats  - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
    print("  exit   - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä\n")

    try:
        while True:
            try:
                cmd = input("\n").strip().lower()
                if cmd == "exit":
                    print("\n[!] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...")
                    break
                elif cmd == "stats":
                    show_stats()
                else:
                    print("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –î–æ—Å—Ç—É–ø–Ω–æ: 'stats', 'exit'")
            except (EOFError, KeyboardInterrupt):
                print("\n[!] –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
                break
    except KeyboardInterrupt:
        print("\n[!] –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")

    print("–°–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É.")